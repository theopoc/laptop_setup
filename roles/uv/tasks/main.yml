---
- name: Include OS-specific variables
  ansible.builtin.include_vars: "{{ lookup('ansible.builtin.first_found', params) }}"
  vars:
    params:
      files:
        - "{{ ansible_os_family }}.yml"
        - "main.yml"
      paths:
        - "vars"
  tags: uv

- name: Get uv path from mise
  ansible.builtin.command:
    cmd: "mise which uv"
  register: uv_path
  changed_when: false
  failed_when: false
  become: false
  check_mode: false
  tags:
    - uv

- name: Update uv shell configuration
  ansible.builtin.command:
    cmd: "{{ uv_path.stdout }} tool update-shell"
  register: uv_shell_update
  become: false
  changed_when: "'Updated' in uv_shell_update.stdout or 'Updated' in uv_shell_update.stderr"
  failed_when:
    - uv_shell_update.rc != 0
    - "'already' not in uv_shell_update.stdout"
    - "'already' not in uv_shell_update.stderr"
    - "'shell could not be determined' not in uv_shell_update.stderr"
  when:
    - uv_path.rc == 0
    - uv_path.stdout is defined
    - uv_path.stdout | length > 0
    - uv_update_shell | bool
  tags:
    - uv
