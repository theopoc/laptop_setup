# MegaLinter GitHub Action configuration file
# More info at https://megalinter.io
---
name: MegaLinter

# Trigger mega-linter at every push. Action will also be visible from
# Pull Requests to main
on:
  # Comment this line to trigger action only on pull-requests
  # (not recommended if you don't pay for GH Actions)
  push:

  pull_request:
    branches:
      - main
      - master

# Comment env block if you do not want to apply fixes
env:
  # Apply linter fixes configuration
  #
  # When active, APPLY_FIXES must also be defined as environment variable
  # (in github/workflows/mega-linter.yml or other CI tool)
  APPLY_FIXES: all

  # Decide which event triggers application of fixes in a commit or a PR
  # (pull_request, push, all)
  APPLY_FIXES_EVENT: pull_request

  # If APPLY_FIXES is used, defines if the fixes are directly committed (commit)
  # or posted in a PR (pull_request)
  APPLY_FIXES_MODE: commit

# concurrency:
#   group: ${{ github.ref }}-${{ github.workflow }}
#   cancel-in-progress: true

jobs:
  megalinter:
    name: MegaLinter

    runs-on: ubuntu-latest

    # Give the default GITHUB_TOKEN write permission to commit and push, comment
    # issues, and post new Pull Requests; remove the ones you do not need
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      # Git Checkout
      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}

          # If you use VALIDATE_ALL_CODEBASE = true, you can remove this line to
          # improve performance
          fetch-depth: 0

      - name: Cache Docker image
        uses: ./.github/actions/docker_image_cache
        id: cache_step
        with:
          image_name_tag: 'ghcr.io/theopoc/megalinter-custom-flavor-ansible/megalinter-custom-flavor:latest'

      # MegaLinter with docker run (bypasses automatic image pull)
      - name: MegaLinter
        if: steps.cache_step.conclusion == 'success'
        env:
          VALIDATE_ALL_CODEBASE: >-
            ${{
              github.event_name == 'push' &&
              github.ref == 'refs/heads/main'
            }}
          LLM_ADVISOR_ENABLED: >-
            ${{
              github.event_name != 'pull_request' ||
              (github.event.pull_request.user.login != 'dependabot[bot]' &&
               github.event.pull_request.user.login != 'renovate[bot]' &&
               github.event.pull_request.user.login != 'github-actions[bot]' &&
               !startsWith(github.event.pull_request.user.login, 'dependabot') &&
               !startsWith(github.event.pull_request.user.login, 'renovate'))
            }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          APPLY_FIXES: all
          APPLY_FIXES_EVENT: pull_request
          APPLY_FIXES_MODE: commit
        run: |
          docker run \
            --name megalinter \
            -e VALIDATE_ALL_CODEBASE="${{ env.VALIDATE_ALL_CODEBASE }}" \
            -e LLM_ADVISOR_ENABLED="${{ env.LLM_ADVISOR_ENABLED }}" \
            -e GITHUB_TOKEN="${{ env.GITHUB_TOKEN }}" \
            -e APPLY_FIXES="${{ env.APPLY_FIXES }}" \
            -e APPLY_FIXES_EVENT="${{ env.APPLY_FIXES_EVENT }}" \
            -e APPLY_FIXES_MODE="${{ env.APPLY_FIXES_MODE }}" \
            -e GITHUB_REPOSITORY="${{ github.repository }}" \
            -e GITHUB_REF="${{ github.ref }}" \
            -e GITHUB_SHA="${{ github.sha }}" \
            -e GITHUB_RUN_ID="${{ github.run_id }}" \
            -e GITHUB_RUN_NUMBER="${{ github.run_number }}" \
            -e GITHUB_EVENT_NAME="${{ github.event_name }}" \
            -e GITHUB_ACTOR="${{ github.actor }}" \
            -e GITHUB_WORKSPACE=/github/workspace \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v ${{ github.workspace }}:/github/workspace \
            --workdir /github/workspace \
            ghcr.io/theopoc/megalinter-custom-flavor-ansible/megalinter-custom-flavor:latest

      # Check if MegaLinter made any changes to files
      - name: Check for modified files
        id: check_changes
        run: |
          if git diff --quiet HEAD; then
            echo "has_updated_sources=0" >> $GITHUB_OUTPUT
          else
            echo "has_updated_sources=1" >> $GITHUB_OUTPUT
          fi

      # Uncomment to use ApiReporter (Grafana)
      # - name: API Reporter
      #   if: always()
      #   env:
      #     API_REPORTER: true
      #     API_REPORTER_URL: ${{ secrets.API_REPORTER_URL }}
      #     API_REPORTER_BASIC_AUTH_USERNAME: ${{ secrets.API_REPORTER_BASIC_AUTH_USERNAME }}
      #     API_REPORTER_BASIC_AUTH_PASSWORD: ${{ secrets.API_REPORTER_BASIC_AUTH_PASSWORD }}
      #     API_REPORTER_METRICS_URL: ${{ secrets.API_REPORTER_METRICS_URL }}
      #     API_REPORTER_METRICS_BASIC_AUTH_USERNAME: ${{ secrets.API_REPORTER_METRICS_BASIC_AUTH_USERNAME }}
      #     API_REPORTER_METRICS_BASIC_AUTH_PASSWORD: ${{ secrets.API_REPORTER_METRICS_BASIC_AUTH_PASSWORD }}
      #     API_REPORTER_DEBUG: false

      # Upload MegaLinter artifacts
      - name: Archive production artifacts
        uses: actions/upload-artifact@v4
        if: success() || failure()
        with:
          name: MegaLinter reports
          include-hidden-files: "true"
          path: |
            megalinter-reports
            mega-linter.log

      # Create pull request if applicable
      # (for now works only on PR from same repository, not from forks)
      - name: Create Pull Request with applied fixes
        uses: peter-evans/create-pull-request@v7
        id: cpr
        if: >-
          steps.check_changes.outputs.has_updated_sources == 1 &&
          (
            env.APPLY_FIXES_EVENT == 'all' ||
            env.APPLY_FIXES_EVENT == github.event_name
          ) &&
          env.APPLY_FIXES_MODE == 'pull_request' &&
          (
            github.event_name == 'push' ||
            github.event.pull_request.head.repo.full_name == github.repository
          ) &&
          !contains(github.event.head_commit.message, 'skip fix')
        with:
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}
          commit-message: "[MegaLinter] Apply linters automatic fixes"
          title: "[MegaLinter] Apply linters automatic fixes"
          labels: bot

      - name: Create PR output
        if: >-
          steps.check_changes.outputs.has_updated_sources == 1 &&
          (
            env.APPLY_FIXES_EVENT == 'all' ||
            env.APPLY_FIXES_EVENT == github.event_name
          ) &&
          env.APPLY_FIXES_MODE == 'pull_request' &&
          (
            github.event_name == 'push' ||
            github.event.pull_request.head.repo.full_name == github.repository
          ) &&
          !contains(github.event.head_commit.message, 'skip fix')
        run: |
          echo "PR Number - ${{ steps.cpr.outputs.pull-request-number }}"
          echo "PR URL - ${{ steps.cpr.outputs.pull-request-url }}"

      # Push new commit if applicable
      # (for now works only on PR from same repository, not from forks)
      - name: Prepare commit
        if: >-
          steps.check_changes.outputs.has_updated_sources == 1 &&
          (
            env.APPLY_FIXES_EVENT == 'all' ||
            env.APPLY_FIXES_EVENT == github.event_name
          ) &&
          env.APPLY_FIXES_MODE == 'commit' &&
          github.ref != 'refs/heads/main' &&
          (
            github.event_name == 'push' ||
            github.event.pull_request.head.repo.full_name == github.repository
          ) &&
          !contains(github.event.head_commit.message, 'skip fix')
        run: sudo chown -Rc $UID .git/

      - name: Commit and push applied linter fixes
        uses: stefanzweifel/git-auto-commit-action@v7
        if: >-
          steps.check_changes.outputs.has_updated_sources == 1 &&
          (
            env.APPLY_FIXES_EVENT == 'all' ||
            env.APPLY_FIXES_EVENT == github.event_name
          ) &&
          env.APPLY_FIXES_MODE == 'commit' &&
          github.ref != 'refs/heads/main' &&
          (
            github.event_name == 'push' ||
            github.event.pull_request.head.repo.full_name == github.repository
          ) &&
          !contains(github.event.head_commit.message, 'skip fix')
        with:
          branch: >-
            ${{
              github.event.pull_request.head.ref ||
              github.head_ref ||
              github.ref
            }}
          commit_message: "[MegaLinter] Apply linters fixes"
          commit_user_name: megalinter-bot
          commit_user_email: 129584137+megalinter-bot@users.noreply.github.com
